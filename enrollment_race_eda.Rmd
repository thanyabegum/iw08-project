---
title: "How did COVID-19 affect US K-12 Enrollment Rates?"
author: "Thanya Begum"
date: "9/21/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(magrittr)
library(piggyback)
library(GGally)
```


## Read In Data Files

```{r}
enr_2021_raw <- read_csv("data/enrollment/nj_enrollment_2021.csv")
enr_1920_raw <- read_csv("data/enrollment/nj_enrollment_1920.csv")
enr_1819_raw <- read_csv("data/enrollment/nj_enrollment_1819.csv")
enr_1718_raw <- read_csv("data/enrollment/nj_enrollment_1718.csv")
enr_1617_raw <- read_csv("data/enrollment/nj_enrollment_1617.csv")
enr_1516_raw <- read_csv("data/enrollment/nj_enrollment_1516.csv")
enr_1415_raw <- read_csv("data/enrollment/nj_enrollment_1415.csv")
enr_1314_raw <- read_csv("data/enrollment/nj_enrollment_1314.csv")
enr_1213_raw <- read_csv("data/enrollment/nj_enrollment_1213.csv")
enr_1112_raw <- read_csv("data/enrollment/nj_enrollment_1112.csv")
enr_1011_raw <- read_csv("data/enrollment/nj_enrollment_1011.csv")
```


## Pre-processing

Some of the datasets have different column names/types. Let's create a function to make them the same, and then apply it to each of the raw datasets we have.

```{r}
# Cleans the raw data so that it has the appropriate column names/types
clean <- function(raw_data) {
    data <- raw_data

    # Select rows with district totals
    if ("PRGCODE" %in% names(raw_data)) {
        data <- raw_data %>% filter(School_ID == 999 & PRGCODE == 55)
    }
    

    if ("School_Name" %in% names(data)) {
        data <- data %>% filter(!(School_Name %in% c("County Total", "State Total")))
    }
    
    
    if ("WH_F" %in% names(data)) {
        # Sum male and female columns of each ethnicity
        data <- data %>% mutate(
            "County Name" = str_to_title(County_Name),
            "District Name" = str_to_title(District_Name),
            "White" = WH_F + WH_M,
            "Black" = BL_F + BL_M,
            "Hispanic" = HI_F + HI_M,
            "Asian" = AS_F + AS_M,
            "Native American" = AM_F + AM_M,
            "Hawaiian Native" = PI_F + PI_M,
            "Two or More Races" = MU_F + MU_M,
            "Total Enrollment" = White + Black + Hispanic + Asian + `Native American` + `Hawaiian Native` + `Two or More Races`
        )
        
        # Remove unnecessary or duplicate columns
        data <- data %>% select(
            -County_Name, -District_Name, -School_ID, -School_Name, -PRGCODE,
            -Row_Total, -WH_F, -WH_M, -BL_F, -BL_M, -HI_F, -HI_M, -AS_F, -AS_M,
            -AM_F, -AM_M, -PI_F, -PI_M, -MU_F, -MU_M
        )
    }
    
    # Remove Grade_Level column
    if ("Grade_Level" %in% names(data)) {
        data <- data %>% select(-Grade_Level)
    }
    
    # Rename columns to match 2020-21 and 2019-20 dataframes
    if ("Dist_ID" %in% names(data)) {
        data <- data %>% rename(
            "County Code" = County_ID,
            "District Code" = Dist_ID,
            "Free Lunch" = Free_Lunch,
            "Reduced Lunch" = Reduced_Price_Lunch,
            "English Learners" = English_Learners
        )

        # Relocate non-ethnicity columns to end of the dataframe
        data <- data %>% relocate(
            `Free Lunch`, `Reduced Lunch`, `English Learners`, Migrant, .after = last_col()
        )
            
        # Relocate Total Enrollment column before races' columns for consistency
        data <- data %>% relocate(`Total Enrollment`, .before = White)

        # Remove unknown District Codes
        data <- data %>% filter(`District Code` != 9999)
    }
    
    if ("%Free Lunch" %in% names(data)) {
        data$`%Free Lunch` <- as.double(data$`%Free Lunch`)
    }

    # Drop NA rows
    data <- data %>% drop_na()

    return(data)
}
```

```{r}
# Uses clean() on the raw datasets
enr_2021 <- clean(enr_2021_raw)
enr_1920 <- clean(enr_1920_raw)
enr_1819 <- clean(enr_1819_raw)
enr_1718 <- clean(enr_1718_raw)
enr_1617 <- clean(enr_1617_raw)
enr_1516 <- clean(enr_1516_raw)
enr_1415 <- clean(enr_1415_raw)
enr_1314 <- clean(enr_1314_raw)
enr_1213 <- clean(enr_1213_raw)
enr_1112 <- clean(enr_1112_raw)
enr_1011 <- clean(enr_1011_raw)
```


## Join The Enrollment Data

We will now join the enrollment dataframes as well as add columns denoting year and race to see the change in enrollment over the past decade.

```{r}
races <- c("White", "Black", "Hispanic", "Asian", "Native American", "Hawaiian Native", "Two or More Races")

# Combines the different race columns into one column called Race, and adds a
# column containing the year of the dataset
add_race_and_year <- function(dataframe, year) {
    dataframe_longer <- dataframe %>% pivot_longer(cols = races, names_to = "Race", names_transform = list(Race = as.factor), values_to = "Enrollment")
    dataframe_longer <- dataframe_longer %>% mutate("Year" = as.factor(year))
    return(dataframe_longer)
}
```

```{r}
# Uses add_race_and_year() on the datasets
enr_1011_longer <- add_race_and_year(enr_1011, "2010-11")
enr_1112_longer <- add_race_and_year(enr_1112, "2011-12")
enr_1213_longer <- add_race_and_year(enr_1213, "2012-13")
enr_1314_longer <- add_race_and_year(enr_1314, "2013-14")
enr_1415_longer <- add_race_and_year(enr_1415, "2014-15")
enr_1516_longer <- add_race_and_year(enr_1516, "2015-16")
enr_1617_longer <- add_race_and_year(enr_1617, "2016-17")
enr_1718_longer <- add_race_and_year(enr_1718, "2017-18")
enr_1819_longer <- add_race_and_year(enr_1819, "2018-19")
enr_1920_longer <- add_race_and_year(enr_1920, "2019-20")
enr_2021_longer <- add_race_and_year(enr_2021, "2020-21")
```

```{r}
# Combine the decade worth of dataframes into a single dataframe
enr <- bind_rows(list(enr_1011_longer, enr_1112_longer, enr_1213_longer,
               enr_1314_longer, enr_1516_longer, enr_1617_longer,
               enr_1718_longer, enr_1819_longer, enr_1920_longer,
               enr_2021_longer))
```


## Calculate Change Between 2019 and 2020 School Years

```{r}
# Calculates the percent change between two numbers
percent_change <- function(initial, final) {
    percent <- ((final - initial) / initial) * 100
    percent[is.nan(percent)] <- NA
    percent[is.infinite(percent)] <- NA
    return (round(percent, 1))
}
```

```{r}
# Join the two tables
enr_1921 <- inner_join(enr_1920, enr_2021, by=c('District Code'='District Code'))

# Add new columns for the change in enrollment for different races, etc.
enr_1921_change <- enr_1921 %>% mutate(
    "Total Enrollment" = percent_change(`Total Enrollment.x`, `Total Enrollment.y`),
    "White" = percent_change(White.x, White.y),
    "Black" = percent_change(Black.x, Black.y),
    "Hispanic" = percent_change(Hispanic.x, Hispanic.y),
    "Asian" = percent_change(Asian.x, Asian.y),
    "Native American" = percent_change(`Native American.x`, `Native American.y`),
    "Hawaiian Native" = percent_change(`Hawaiian Native.x`, `Hawaiian Native.y`),
    "Two Or More Races" = percent_change(`Two or More Races.x`, `Two or More Races.y`),
    "%Free Lunch" = `%Free Lunch.y` - `%Free Lunch.x`,
    "%Reduced Lunch" = `%Reduced Lunch.y` - `%Reduced Lunch.x`,
    "Pre-K FullDay" = percent_change(`Pre-K Halfday.x`, `Pre-K Halfday.y`),
    "Pre-K Halfday" = percent_change(`Pre-K FullDay.x`, `Pre-K FullDay.y`),
    "Kindergarten Halfday" = percent_change(`Kindergarten Halfday.x`, `Kindergarten Halfday.y`),
    "Kindergarten Fullday" = percent_change(`Kindergarten Fullday.x`, `Kindergarten Fullday.y`),
    "First Grade" = percent_change(`First Grade.x`, `First Grade.y`),
    "Second Grade" = percent_change(`Second Grade.x`, `Second Grade.y`),
    "Third Grade" = percent_change(`Third Grade.x`, `Third Grade.y`),
    "Fourth Grade" = percent_change(`Fourth Grade.x`, `Fourth Grade.y`),
    "Fifth Grade" = percent_change(`Fifth Grade.x`, `Fifth Grade.y`),
    "Sixth Grade" = percent_change(`Sixth Grade.x`, `Sixth Grade.y`),
    "Seventh Grade" = percent_change(`Seventh Grade.x`, `Seventh Grade.y`),
    "Eighth Grade" = percent_change(`Eighth Grade.x`, `Eighth Grade.y`),
    "Ninth Grade" = percent_change(`Ninth Grade.x`, `Ninth Grade.y`),
    "Tenth Grade" = percent_change(`Tenth Grade.x`, `Tenth Grade.y`),
    "Eleventh Grade" = percent_change(`Eleventh Grade.x`, `Eleventh Grade.y`),
    "Twelfth Grade" = percent_change(`Twelfth Grade.x`, `Twelfth Grade.y`),
)

# Select only the columns that matter
enr_1921_change <- enr_1921_change %>% select(
    `County Code.x`, `County Name.x`, `District Code`, `District Name.x`,
    `Total Enrollment`, `White`, `Black`,
    `Hispanic`, `Asian`, `Native American`,
    `Hawaiian Native`, `Two Or More Races`, `%Free Lunch`,
    `%Reduced Lunch`, `Pre-K Halfday`, `Pre-K FullDay`, `Kindergarten Halfday`,
    `Kindergarten Fullday`, `First Grade`, `Second Grade`,
    `Third Grade`, `Fourth Grade`, `Fifth Grade`,
    `Sixth Grade`, `Seventh Grade`, `Eighth Grade`,
    `Ninth Grade`, `Tenth Grade`, `Eleventh Grade`,
    `Twelfth Grade`
)

# Rename those columns
names(enr_1921_change)[1:4] <- c("County Code", "County Name", "District Code", "District Name")

# Export as csv
write.csv(enr_1921_change, file="output/enrollment_1921_change.csv", row.names=FALSE)
```

```{r}
# Plot correlation coefficients and scatter plots
ggpairs(enr_1921_change %>% select(-`County Code`, -`County Name`, -`District Code`, -`District Name`))
```


## Data Visualizations

# How has enrollment changed between public schools and charters?

```{r}
# Total enrollment for the 2019-2020 school year
find_total <- function(data) {
    data <- data %>% 
        bind_rows(summarise(., across(where(is.numeric), sum), across(where(is.character), ~"Total"))) %>% 
        tail(1) %>% 
        select(
            -`County Code`, -`County Name`, -`District Code`, -`District Name`,
            -`%White`, -`%Black`, -`%Hispanic`, -`%Asian`, -`%Native American`,
            -`%Hawaiian Native`, -`%Two or More Races`
        )
    return (data)
}

enr_1920_total_public <- find_total(enr_1920 %>% filter(`County Code` != 80))
enr_1920_total_charter <- find_total(enr_1920 %>% filter(`County Code` == 80))
enr_2021_total_public <- find_total(enr_2021 %>% filter(`County Code` != 80))
enr_2021_total_charter <- find_total(enr_2021 %>% filter(`County Code` == 80))

# Difference in enrollment between public and charter schools from 2019 to 2020 school years
enr_1921_change_public <- ((enr_2021_total_public - enr_1920_total_public) / enr_1920_total_public) * 100
enr_1921_change_charter <- ((enr_2021_total_charter - enr_1920_total_charter) / enr_1920_total_charter) * 100

# Pivot longer
enr_1921_change_charter_longer <- enr_1921_change_charter %>% 
    select(ends_with("Grade") | contains("Pre-K") | contains ("Kindergarten")) %>% 
    pivot_longer(cols = everything(), names_to = "Grade", names_transform = list(Grade = as.factor), values_to = "% Enrollment Change")
enr_1921_change_public_longer <- enr_1921_change_public %>% 
    select(ends_with("Grade") | contains("Pre-K") | contains ("Kindergarten")) %>% 
    pivot_longer(cols = everything(), names_to = "Grade", names_transform = list(Grade = as.factor), values_to = "% Enrollment Change")

# Reorder levels
enr_1921_change_charter_longer$Grade <- ordered(enr_1921_change_charter_longer$Grade, levels = c("Pre-K Halfday", "Pre-K FullDay", "Kindergarten Halfday", "Kindergarten Fullday", "First Grade", "Second Grade", "Third Grade", "Fourth Grade", "Fifth Grade", "Sixth Grade", "Seventh Grade", "Eighth Grade", "Ninth Grade", "Tenth Grade", "Eleventh Grade", "Twelfth Grade"))

enr_1921_change_public_longer$Grade <- ordered(enr_1921_change_public_longer$Grade, levels = c("Pre-K Halfday", "Pre-K FullDay", "Kindergarten Halfday", "Kindergarten Fullday", "First Grade", "Second Grade", "Third Grade", "Fourth Grade", "Fifth Grade", "Sixth Grade", "Seventh Grade", "Eighth Grade", "Ninth Grade", "Tenth Grade", "Eleventh Grade", "Twelfth Grade"))
    
# Plot
enr_1921_change_charter_longer %>% 
    ggplot(aes(x = Grade, y = `% Enrollment Change`, fill = (`% Enrollment Change` > 0))) +
    geom_col(position = "identity") +
    theme(legend.position = "none") +
    labs(title = "Charter Schools Change in Enrollment by Grade")

enr_1921_change_public_longer %>%
    ggplot(aes(x = Grade, y = `% Enrollment Change`, fill = (`% Enrollment Change` > 0))) +
    geom_col(position = "identity") +
    theme(legend.position = "none") +
    labs(title = "Public Schools Change in Enrollment by Grade")

# Combine plots
enr_1921_change_both_longer <- bind_rows(
    enr_1921_change_charter_longer %>% mutate("Type" = as.factor("Charter")),
    enr_1921_change_public_longer %>% mutate("Type" = as.factor("Public"))
)

enr_1921_change_both_longer %>%
    ggplot(aes(x = Grade, y = `% Enrollment Change`, fill = Type)) +
    geom_bar(position = "dodge", stat = "identity") +
    labs(title = "NJ Schools Change in Enrollment by Grade and School Type") +
    scale_fill_brewer(palette="Paired")
```


```{r}
enr_1921_longer <- enr_1921_change %>% pivot_longer(
    cols = c("Pre-K FullDay", "Kindergarten Halfday",
           "Kindergarten Fullday", "First Grade", "Second Grade",
           "Third Grade", "Fourth Grade", "Fifth Grade",
           "Sixth Grade", "Seventh Grade", "Eighth Grade",
           "Ninth Grade", "Tenth Grade", "Eleventh Grade",
           "Twelfth Grade"),
    names_to = "Grade",
    names_transform = list(Grade = as.factor),
    values_to = "Enrollment Change"
)

enr_1921_longer %>% ggplot(aes(x = Grade, y = `Enrollment Change`, fill = Grade)) +
    geom_col(position = "identity")
```

```{r}
plot_enr_by_race_for_district <- function(data, district_code) {
    data$Race <- ordered(data$Race, levels = c("Black", "White", "Asian", "Hispanic", "Two or More Races", "Native American", "Hawaiian Native"))
    
    data %>% 
        filter(`District Code` == district_code) %>% 
        ggplot(aes(x = Year, y = Enrollment, group = Race, color = Race)) +
        geom_line() +
        geom_point() +
        ylim(0, 1500) +
        labs(title = str_interp("District ${district_code} Enrollment From 2010 to 2021 by Race")) +
        scale_color_manual(values=c("firebrick1", "brown", "green", "skyblue", "orange", "black", "purple", "hotpink"))
}

plot_enr_by_race_for_district(enr, "2520")

```

```{r}
plot_enr_by_race_for_county <- function(data, county_code) {
    data %>% 
        filter(`Code Code` == county_code) %>% 
        ggplot(aes(x = Year, y = Enrollment, group = Race, color = Race)) +
        geom_line() +
        geom_point() +
        labs(title = str_interp("County ${district_code} Enrollment From 2010 to 2021 by Race"))
}

plot_enr_by_race_for_county(enr, "01")

```

```{r}
enr_totals_by_year <- enr %>% filter(Race != "Total Enrollment") %>% group_by(Year) %>% summarize("Total Enrollment" = sum(Enrollment))
enr_totals_by_race <- enr %>% filter(Race != "Total Enrollment") %>% group_by(Year, Race) %>% summarize("Total Enrollment" = sum(Enrollment))
enr_totals_by_county <- enr %>% filter(Race != "Total Enrollment") %>% group_by(Year, Race, `County Code`) %>% summarize("Total Enrollment" = sum(Enrollment))
enr_totals_by_city <- enr %>% filter(Race != "Total Enrollment") %>% group_by(Year, Race, `County Code`) %>% summarize("Total Enrollment" = sum(Enrollment))

enr_totals_by_year %>% ggplot(aes(x = Year, y = `Total Enrollment`, group = 1)) +
    geom_line() +
    geom_point() +
    ylim(1200000, 1500000) +
    labs(title = "NJ Total Enrollment From 2010 to 2021")

# Reorder legend labels by reording factor levels
enr_totals_by_race$Race <- ordered(enr_totals_by_race$Race, 
                                   levels = c("White", "Hispanic", "Black",
                                              "Asian", "Two or More Races",
                                              "Native American", "Hawaiian Native"))
enr_totals_by_race %>% 
    ggplot(aes(x = Year, y = `Total Enrollment`, group = Race, color = Race)) +
    geom_line() +
    geom_point() +
    labs(title = "NJ Total Enrollment From 2010 to 2021 by Race") +
    scale_color_manual(values=c("firebrick1", "brown", "green", "skyblue", "orange", "black", "purple", "hotpink"))

enr_totals_by_county %>% filter(`County Code` == "23") %>% 
    ggplot(aes(x = Year, y = `Total Enrollment`, group = Race, color = Race)) +
    geom_line() +
    geom_point() +
    labs(title = "Middlesex County Total Enrollment From 2010 to 2021 by Race")

```


## Miscellaneous

```{r}
#
enr_1921_longer <- enr_1921 %>% pivot_longer(
    cols = c("Total Enrollment Change", "White Change", "Black Change", "Hispanic Change",
             "Asian Change", "Native American Change", "Hawaiian Native Change",
             "Two Or More Races Change", "%Free Lunch Change", "%Reduced Lunch Change"),
    names_to = "Type",
    names_transform = list(Type = as.factor),
    values_to = "Enrollment Change"
)

#
write.csv(enr_1921_longer, file="output/enrollment_1921_change_longer.csv", row.names=FALSE)
```

```{r, eval = FALSE}
enr_covid <- full_join(enr_1920, enr_2021, by = c(
    "District Code" = "District Code"
))
enr_covid <- enr_covid %>% mutate("Enrollment Change" = `Total Enrollment.y` - `Total Enrollment.x`)

enr_covid_change <- enr_covid_change %>% select(c(`County Code.y`, `County Name.y`, `District Code`, `District Name.y`, `Enrollment Change`))
names(enr_covid_change) <- c("County Code", "County Name", "District Code", "District Name", "Enrollment Change")
write.csv(enr_covid_change, file="output/enrollment_change.csv", row.names=FALSE)
```
